<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Watch Pro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to prevent cutting off on small screens */
            min-height: 100vh;
            margin: 0;
            padding: 2rem 1rem; /* Add some padding for smaller screens */
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 95%;
            width: 480px;
        }
        .button {
            transition: all 0.2s ease-in-out;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        /* Style for the number input */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container flex flex-col items-center">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Rate Watch Pro</h1>
        <p class="text-gray-500 mb-6">A tool for measuring rowing stroke rate.</p>

        <!-- Configuration Section -->
        <div class="mb-6 w-full bg-gray-50 p-4 rounded-xl border border-gray-200">
            <label for="strokeCount" class="text-lg font-semibold text-gray-700">Strokes to Measure:</label>
            <input type="number" id="strokeCount" value="3" min="1" class="mt-2 w-24 text-center text-2xl font-bold p-2 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
        </div>

        <!-- Display section for Time and SPM -->
        <div class="mb-8 w-full grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="bg-blue-50 p-6 rounded-xl shadow-inner flex-1">
                <p class="text-lg font-semibold text-blue-700">Time Elapsed:</p>
                <p id="timeDisplay" class="text-5xl font-bold text-blue-900 mt-2">0.0s</p>
            </div>
            <div class="bg-green-50 p-6 rounded-xl shadow-inner flex-1">
                <p class="text-lg font-semibold text-green-700">Strokes Per Minute:</p>
                <p id="spmDisplay" class="text-5xl font-bold text-green-900 mt-2">0.0</p>
            </div>
        </div>

        <button id="mainButton" class="button w-full py-4 px-6 bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold text-2xl rounded-xl shadow-lg hover:from-blue-600 hover:to-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300">
            Start
        </button>

        <p id="instructionText" class="text-sm text-gray-500 mt-6">Click "Start", complete the strokes, then click "Stop".</p>

        <!-- Section for previous records -->
        <div id="previousRecords" class="mt-10 w-full">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold text-gray-700">History</h2>
                 <button id="clearHistoryButton" class="text-sm text-red-500 hover:text-red-700 font-semibold transition">Clear History</button>
            </div>
            <div id="averageSpmSection" class="bg-yellow-50 p-4 rounded-xl mb-4 border border-yellow-200 hidden">
                <p class="text-lg font-semibold text-yellow-800">Average SPM: <span id="averageSpmDisplay" class="font-bold">0.0</span></p>
            </div>
            <ul id="historyList" class="list-none p-0 m-0 space-y-2">
                <!-- History items will be inserted here by JavaScript -->
            </ul>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const mainButton = document.getElementById('mainButton');
        const timeDisplay = document.getElementById('timeDisplay');
        const spmDisplay = document.getElementById('spmDisplay');
        const instructionText = document.getElementById('instructionText');
        const historyList = document.getElementById('historyList');
        const strokeCountInput = document.getElementById('strokeCount');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const averageSpmSection = document.getElementById('averageSpmSection');
        const averageSpmDisplay = document.getElementById('averageSpmDisplay');

        // State variables for the application
        let timerRunning = false;
        let startTime = 0;
        let previousSpms = [];
        const maxHistoryRecords = 10; // Increased history size

        /**
         * Loads previous records from localStorage when the page loads.
         */
        function loadHistoryFromStorage() {
            const storedSpms = localStorage.getItem('rowingRateHistory');
            if (storedSpms) {
                previousSpms = JSON.parse(storedSpms);
            }
            updateHistoryDisplay();
        }

        /**
         * Saves the current history to localStorage.
         */
        function saveHistoryToStorage() {
            localStorage.setItem('rowingRateHistory', JSON.stringify(previousSpms));
        }

        /**
         * Updates the display of previous stroke rate records and the average.
         */
        function updateHistoryDisplay() {
            historyList.innerHTML = ''; // Clear existing list items

            if (previousSpms.length === 0) {
                const listItem = document.createElement('li');
                listItem.className = 'text-gray-500 text-center py-2';
                listItem.textContent = 'No records yet.';
                historyList.appendChild(listItem);
                averageSpmSection.classList.add('hidden'); // Hide average section if no history
            } else {
                // Show average section
                averageSpmSection.classList.remove('hidden');
                const totalSpm = previousSpms.reduce((sum, spm) => sum + spm, 0);
                const averageSpm = totalSpm / previousSpms.length;
                averageSpmDisplay.textContent = averageSpm.toFixed(1);

                // Iterate in reverse to show most recent at the top
                previousSpms.slice().reverse().forEach((spm, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-gray-100 p-3 rounded-lg flex justify-between items-center';
                    const recordNumber = previousSpms.length - index;
                    listItem.innerHTML = `<span class="font-semibold text-gray-600">Record #${recordNumber}</span> <span class="font-bold text-gray-800 text-xl">${spm.toFixed(1)} SPM</span>`;
                    historyList.appendChild(listItem);
                });
            }
        }
        
        /**
         * Handles the main button click to start/stop the timer.
         */
        mainButton.addEventListener('click', () => {
            const targetStrokes = parseInt(strokeCountInput.value, 10);
            if (isNaN(targetStrokes) || targetStrokes < 1) {
                alert("Please enter a valid number of strokes.");
                return;
            }

            if (!timerRunning) {
                // --- STATE 1: START TIMER ---
                startTime = performance.now();
                timerRunning = true;
                strokeCountInput.disabled = true; // Disable input while running

                mainButton.textContent = 'Stop';
                mainButton.classList.remove('from-blue-500', 'to-blue-700', 'hover:from-blue-600', 'hover:to-blue-800');
                mainButton.classList.add('from-red-500', 'to-red-700', 'hover:from-red-600', 'hover:to-red-800');

                timeDisplay.textContent = '...';
                spmDisplay.textContent = '...';
                instructionText.textContent = `Complete ${targetStrokes} strokes, then click "Stop".`;

            } else {
                // --- STATE 2: STOP TIMER & CALCULATE ---
                const endTime = performance.now();
                const timeElapsedMs = endTime - startTime;
                const timeElapsedSeconds = timeElapsedMs / 1000;

                // Prevent division by zero or absurdly fast times
                if (timeElapsedSeconds < 0.1) {
                    alert("Time elapsed is too short for a valid measurement.");
                    // Reset without saving
                } else {
                    const strokesPerMinute = (targetStrokes / timeElapsedSeconds) * 60;

                    timeDisplay.textContent = `${timeElapsedSeconds.toFixed(1)}s`;
                    spmDisplay.textContent = `${strokesPerMinute.toFixed(1)}`;

                    // Add the new SPM to the history
                    previousSpms.push(strokesPerMinute);
                    if (previousSpms.length > maxHistoryRecords) {
                        previousSpms.shift(); // Remove the oldest record
                    }
                    saveHistoryToStorage();
                    updateHistoryDisplay();
                }

                // --- RESET UI ---
                timerRunning = false;
                strokeCountInput.disabled = false; // Re-enable input
                mainButton.textContent = 'Start';
                mainButton.classList.remove('from-red-500', 'to-red-700', 'hover:from-red-600', 'hover:to-red-800');
                mainButton.classList.add('from-blue-500', 'to-blue-700', 'hover:from-blue-600', 'hover:to-blue-800');
                instructionText.textContent = 'Click "Start", complete the strokes, then click "Stop".';
            }
        });

        /**
         * Clears all records from history and localStorage.
         */
        clearHistoryButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all history? This cannot be undone.")) {
                previousSpms = [];
                saveHistoryToStorage();
                updateHistoryDisplay();
            }
        });

        // Initial load from storage when the app starts
        loadHistoryFromStorage();
    </script>
</body>
</html>
