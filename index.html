<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Watch Pro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to prevent cutting off on small screens */
            min-height: 100vh;
            margin: 0;
            padding: 2rem 1rem; /* Add some padding for smaller screens */
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 95%;
            width: 480px;
        }
        .button {
            transition: all 0.2s ease-in-out;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        /* Style for the number input */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container flex flex-col items-center">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Rate Watch Pro</h1>
        <p class="text-gray-500 mb-6">A tool for measuring rowing stroke rate.</p>

        <!-- Configuration Section -->
        <div class="mb-6 w-full bg-gray-50 p-4 rounded-xl border border-gray-200">
            <label for="strokeCount" class="text-lg font-semibold text-gray-700">Strokes to Measure:</label>
            <input type="number" id="strokeCount" value="3" min="1" class="mt-2 w-24 text-center text-2xl font-bold p-2 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
        </div>

        <!-- Display section for Time and SPM -->
        <div class="mb-8 w-full grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="bg-blue-50 p-6 rounded-xl shadow-inner flex-1">
                <p class="text-lg font-semibold text-blue-700">Time Elapsed:</p>
                <p id="timeDisplay" class="text-5xl font-bold text-blue-900 mt-2">0.0s</p>
            </div>
            <div class="bg-green-50 p-6 rounded-xl shadow-inner flex-1">
                <p class="text-lg font-semibold text-green-700">Strokes Per Minute:</p>
                <p id="spmDisplay" class="text-5xl font-bold text-green-900 mt-2">0.0</p>
            </div>
        </div>

        <button id="mainButton" class="button w-full py-4 px-6 bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold text-2xl rounded-xl shadow-lg hover:from-blue-600 hover:to-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300">
            Start
        </button>

        <p id="instructionText" class="text-sm text-gray-500 mt-6">Click "Start" at the catch and "Stop" at the catch to record the time for a full stroke. After collecting 3+ records a graph will display.</p>

        <!-- Section for previous records -->
        <div id="previousRecords" class="mt-10 w-full">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold text-gray-700">History</h2>
                 <button id="clearHistoryButton" class="text-sm text-red-500 hover:text-red-700 font-semibold transition">Clear History</button>
            </div>
            <div id="averageSpmSection" class="bg-yellow-50 p-4 rounded-xl mb-4 border border-yellow-200 hidden">
                <p class="text-lg font-semibold text-yellow-800">Average SPM: <span id="averageSpmDisplay" class="font-bold">0.0</span></p>
            </div>
            <ul id="historyList" class="list-none p-0 m-0 space-y-2">
                <!-- History items will be inserted here by JavaScript -->
            </ul>
        </div>
        
        <!-- Graph Section -->
        <div id="graphContainer" class="mt-10 w-full">
             <canvas id="historyChart" style="display: none;"></canvas>
        </div>

        <!-- Export Section -->
        <div id="exportContainer" class="mt-10 w-full border-t pt-6">
            <button id="exportButton" class="button w-full py-3 px-6 bg-gradient-to-r from-gray-600 to-gray-800 text-white font-semibold text-lg rounded-xl shadow-lg hover:from-gray-700 hover:to-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Export to CSV
            </button>
        </div>

    </div>

    <script>
        // Get references to DOM elements
        const mainButton = document.getElementById('mainButton');
        const timeDisplay = document.getElementById('timeDisplay');
        const spmDisplay = document.getElementById('spmDisplay');
        const instructionText = document.getElementById('instructionText');
        const historyList = document.getElementById('historyList');
        const strokeCountInput = document.getElementById('strokeCount');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const averageSpmSection = document.getElementById('averageSpmSection');
        const averageSpmDisplay = document.getElementById('averageSpmDisplay');
        const chartCanvas = document.getElementById('historyChart');
        const exportButton = document.getElementById('exportButton');

        // State variables for the application
        let timerRunning = false;
        let startTime = 0;
        let previousSpms = [];
        const maxHistoryRecords = 10;
        let historyChart; // Variable to hold the chart instance

        /**
         * Loads previous records from localStorage when the page loads.
         */
        function loadHistoryFromStorage() {
            const storedSpms = localStorage.getItem('rowingRateHistory');
            if (storedSpms) {
                previousSpms = JSON.parse(storedSpms);
            }
            updateHistoryDisplay();
        }

        /**
         * Saves the current history to localStorage.
         */
        function saveHistoryToStorage() {
            localStorage.setItem('rowingRateHistory', JSON.stringify(previousSpms));
        }
        
        /**
         * Updates the chart display based on the current history.
         */
        function updateChartDisplay() {
            if (previousSpms.length < 3) {
                chartCanvas.style.display = 'none';
                if (historyChart) {
                    historyChart.destroy();
                    historyChart = null;
                }
                return;
            }
            
            chartCanvas.style.display = 'block';

            const labels = previousSpms.map(record => 
                new Date(record.timestamp).toLocaleTimeString('en-AU', {
                    timeZone: 'Australia/Sydney',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            );
            const data = previousSpms.map(record => record.spm);

            if (historyChart) {
                historyChart.data.labels = labels;
                historyChart.data.datasets[0].data = data;
                historyChart.update();
            } else {
                const ctx = chartCanvas.getContext('2d');
                historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Strokes Per Minute',
                            data: data,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: false, title: { display: true, text: 'Rate (SPM)', font: { weight: 'bold' } } },
                            x: { title: { display: true, text: 'Time', font: { weight: 'bold' } } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { displayColors: false, callbacks: { label: context => `Rate: ${context.raw.toFixed(1)} SPM` } }
                        }
                    }
                });
            }
        }

        /**
         * Updates the display of previous stroke rate records and the average.
         */
        function updateHistoryDisplay() {
            historyList.innerHTML = '';

            if (previousSpms.length === 0) {
                const listItem = document.createElement('li');
                listItem.className = 'text-gray-500 text-center py-2';
                listItem.textContent = 'No records yet.';
                historyList.appendChild(listItem);
                averageSpmSection.classList.add('hidden');
            } else {
                averageSpmSection.classList.remove('hidden');
                const totalSpm = previousSpms.reduce((sum, record) => sum + record.spm, 0);
                const averageSpm = totalSpm / previousSpms.length;
                averageSpmDisplay.textContent = averageSpm.toFixed(1);

                previousSpms.slice().reverse().forEach((record, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-gray-100 p-3 rounded-lg flex justify-between items-center';
                    const recordNumber = previousSpms.length - index;
                    const timeString = new Date(record.timestamp).toLocaleString('en-AU', {
                        timeZone: 'Australia/Sydney',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    }).toUpperCase();

                    listItem.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-600">Record #${recordNumber}</span>
                            <span class="font-bold text-gray-800 text-xl ml-4">${record.spm.toFixed(1)} SPM</span>
                        </div>
                        <span class="text-sm text-gray-500 font-medium">${timeString}</span>
                    `;
                    historyList.appendChild(listItem);
                });
            }
            updateChartDisplay();
        }
        
        /**
         * Handles the main button click to start/stop the timer.
         */
        mainButton.addEventListener('click', () => {
            const targetStrokes = parseInt(strokeCountInput.value, 10);
            if (isNaN(targetStrokes) || targetStrokes < 1) {
                alert("Please enter a valid number of strokes.");
                return;
            }

            if (!timerRunning) {
                startTime = performance.now();
                timerRunning = true;
                strokeCountInput.disabled = true;
                mainButton.textContent = 'Stop';
                mainButton.classList.remove('from-blue-500', 'to-blue-700');
                mainButton.classList.add('from-red-500', 'to-red-700');
                timeDisplay.textContent = '...';
                spmDisplay.textContent = '...';
                instructionText.textContent = `Complete ${targetStrokes} strokes, then click "Stop".`;
            } else {
                const endTime = performance.now();
                const timeElapsedSeconds = (endTime - startTime) / 1000;

                if (timeElapsedSeconds > 0.1) {
                    const strokesPerMinute = (targetStrokes / timeElapsedSeconds) * 60;
                    timeDisplay.textContent = `${timeElapsedSeconds.toFixed(1)}s`;
                    spmDisplay.textContent = `${strokesPerMinute.toFixed(1)}`;
                    const newRecord = { spm: strokesPerMinute, timestamp: new Date().toISOString() };
                    previousSpms.push(newRecord);
                    if (previousSpms.length > maxHistoryRecords) {
                        previousSpms.shift();
                    }
                    saveHistoryToStorage();
                    updateHistoryDisplay();
                }

                timerRunning = false;
                strokeCountInput.disabled = false;
                mainButton.textContent = 'Start';
                mainButton.classList.remove('from-red-500', 'to-red-700');
                mainButton.classList.add('from-blue-500', 'to-blue-700');
                instructionText.textContent = 'Click "Start" at the catch and "Stop" at the catch to record the time for a full stroke. After collecting 3+ records a graph will display.';
            }
        });

        /**
         * Clears all records from history and localStorage.
         */
        clearHistoryButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all history? This cannot be undone.")) {
                previousSpms = [];
                saveHistoryToStorage();
                updateHistoryDisplay();
            }
        });
        
        /**
         * Exports the history data to a CSV file.
         */
        function exportToCsv() {
            if (previousSpms.length === 0) {
                alert("There is no history to export.");
                return;
            }

            const headers = ["Record Number", "SPM", "Date (AEST)", "Time (AEST)"];
            let csvRows = [headers.join(",")];

            previousSpms.forEach((record, index) => {
                const recordNumber = index + 1;
                const spm = record.spm.toFixed(1);
                const recordDate = new Date(record.timestamp);
                const dateString = recordDate.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });
                const timeString = recordDate.toLocaleTimeString('en-AU', { timeZone: 'Australia/Sydney', hour12: false });
                csvRows.push([recordNumber, spm, `"${dateString}"`, `"${timeString}"`].join(","));
            });

            const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\r\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "rowing_rate_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add event listener for the export button
        exportButton.addEventListener('click', exportToCsv);

        // Initial load from storage when the app starts
        loadHistoryFromStorage();
    </script>
</body>
</html>
